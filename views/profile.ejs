<!DOCTYPE html>
<html>
  <head>
    <title><%= title %></title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">  </head>
    <link rel="stylesheet" href="/stylesheets/profile.css">
  <body>
    <%- include('bar', {req: req}); %>
    <br/>
    <br/>
    <br/>
    <div class="w3-container w3-center">
      <h1><%= user.username %></h1>
      <p>Hello <%= user.username %>, your user details can be found below.</p>
      <table class="w3-table w3-bordered w3-display-middle" style="width:15%">
        <tbody>
          <tr>
            <td class="tg-1wig"><strong>Data</strong></td>
            <td class="tg-1wig"><strong>Value</strong></td>
          </tr>
          <tr>
            <td class="tg-0pky">Username</td>
            <td class="tg-0pky"><%= user.username %></td>
          </tr>
          <tr>
            <td class="tg-0pky">E-mail address</td>
            <td class="tg-0pky"><%= user.email %></td>
          </tr>
          <tr>
            <td class="tg-0pky">UserPage</td>
            <td class="tg-0pky"><input type="checkbox" id="up-box" onchange="createUserPage()"><p id="upstatus">Loading status...</p></td>
          </tr>
          <tr>
            <td class="tg-0pky">Colour Preference</td>
            <td class="tg-0pky w3-center">
              <form action="/profilesettings" method="POST">
                <% if(user.rgb == ""){ %>
                  <input type="color" name="color" id="color" value="#B4B4B4" required/>
                <% } else { %>
                  <% var a = user.rgb; a = a.split(","); var b = a.map(function(x){ x = parseInt(x).toString(16); return (x.length==1) ? "0"+x : x; }); b = "#"+b.join(""); var hexcol = b %>
                  <input type="color" name="color" id="color" value="<%= hexcol %>" required/>
                <% } %>
                <button type="sumbit">Save</button>
              </form>
            </td>
          </tr>
        </tbody>
      </table>
      <script>
        var url = '/api/userpage/<%= user.username %>';
        console.log("running!");
        var http = new XMLHttpRequest();
        http.open('GET', url, false);
        http.send();
        var upbox = document.getElementById('up-box');
        var uppar = document.getElementById('upstatus');
        console.log(http);
        if (http.status != 404){
          upbox.setAttribute("checked", "checked");
          upbox.setAttribute("disabled","disabled");
          if(http.status == 201){
            uppar.innerText = "Custom";
          }
          else {
            uppar.innerText = "Profile";
          }
        } else if(http.status == 500) { 
          upbox.setAttribute("disabled","disabled")
          uppar.innerText = "Error";
          alert("An error occurred checking the current status of your UserPage. Please try again later.");
        } else {
          upbox.removeAttribute("checked");
          upbox.removeAttribute("disabled");
          uppar.innerText = "";
        }
        function createUserPage(){
          var c_http = new XMLHttpRequest();
          c_http.open('POST', "/up-edit", false);
          c_http.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
          c_http.send(JSON.stringify({"function": "create"}));
          console.log(c_http);
          location.reload();
        }
      </script>
    </div>
  </body>
</html>
